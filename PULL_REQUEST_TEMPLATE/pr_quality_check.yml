name: PR Quality Check
on:
  pull_request:
    types: [opened, edited, synchronize]

jobs:
  validate:
    name: Staðfesta svör í PR
    runs-on: ubuntu-latest
    permissions:
      pull-requests: read
      contents: read
    steps:
      - name: Sækja PR texta
        uses: actions/github-script@v7
        with:
          script: |
            const body = (context.payload.pull_request.body || "").trim();

            // Gróf lágmarksviðmið
            const minImproveChars = 80; // pínu „pína“ að rökstyðja
            const mustContain = [
              "Uppfyllir atriðið matskvarða með verkefninu",
              "Er textinn læsilegur og réttur",
              "Skrifaðu hvað má betur fara"
            ];

            // Athuga að formspurningarnar sjást í body (GitHub renderar labels yfirleitt í body)
            const missingLabels = mustContain.filter(lbl => !body.toLowerCase().includes(lbl.toLowerCase()));
            if (missingLabels.length > 0) {
              core.setFailed(`Vantar eftirfarandi reiti úr PR formi: ${missingLabels.join(", ")}`);
              return;
            }

            // Ná í svarlínur með einföldum leitum (virkar bæði fyrir form og venjulegan texta)
            function extractAnswer(label) {
              // Reynum að ná texta undir label (allt að næsta label eða enda).
              const regex = new RegExp(`${label}[\\s\\S]*?\\n\\n([\\s\\S]*?)\\n\\n`, "i");
              const m = body.match(regex);
              if (m && m[1]) return m[1].trim();
              // fallback – leita eftir label og taka næstu 500 stafi
              const idx = body.toLowerCase().indexOf(label.toLowerCase());
              if (idx >= 0) return body.slice(idx, idx + 500).trim();
              return "";
            }

            const improveAns = extractAnswer("Skrifaðu hvað má betur fara");

            // Lágmarkslengd á „hvað má betur fara“
            if (improveAns.replace(/\s+/g, " ").length < minImproveChars) {
              core.setFailed(`Svar við „Skrifaðu hvað má betur fara“ er of stutt (min ${minImproveChars} stafir). Bættu við skýrari atriðum og rökstuðningi.`);
              return;
            }

            // Hvetja til a.m.k. 2 punkta (ekki fail, bara viðvörun)
            const bullets = (improveAns.match(/^\s*[-*0-9)]+\s+/gm) || []).length;
            if (bullets < 2 && improveAns.split(/\n+/).length < 2) {
              core.warning("Mælt er með að nefna a.m.k. tvö atriði (punktalisti eða aðskildar línur).");
            }

            core.info("PR Quality Check: í lagi ✅");
